{
  "alter": {
    "object": {
      "database": "3c83022b-0131-42d5-96fb-453c997c1b15",
      "table": "FYCALENDAR_D",
      "partition": "FYCALENDAR_D"
    },
    "partition": {
      "name": "FYCALENDAR_D",
      "mode": "import",
      "queryGroup": "DIM",
      "source": {
        "type": "m",
        "expression": "let\n    // The FiscalYearEnd determines in which month the fiscal year ends. If necessary you can adjust it. \n    FiscalYearEnd = 9,\n\n    // Today is used throughout the fiscal logic and for determining current period flags\n    Today = Date.From(DateTime.LocalNow()),\n\n    // Sets the start date for your calendar\n    StartDate = #date(2000, 1, 1),\n\n    // The calendar runs until the end of the current year. Change this if you need your calendar to run to another date. \n    EndDate = Date.AddYears(Date.EndOfYear(Today),1),\n\n    // The current Fiscal Year value is a helper value for other calculations\n    CurrentFiscalYear = Date.Year( Date.AddMonths( Today, 12 - FiscalYearEnd ) ),\n\n    ListOfDates =\n        List.Dates(\n            StartDate,\n            Duration.Days(EndDate - StartDate) + 1,\n            #duration(1, 0, 0, 0)\n        ),\n\n    MyDateTable =\n        Table.FromList(\n            ListOfDates,\n            Splitter.SplitByNothing(),\n            type table[Date = date],\n            null,\n            ExtraValues.Error\n        ),\n\n    Add_FiscalYearNumber =\n        Table.AddColumn(\n            MyDateTable,\n            \"FiscalYear\",\n            each Date.Year(Date.AddMonths([Date], 12 - FiscalYearEnd)),\n            Int64.Type\n        ),\n\n    Add_FiscalYearLabel =\n        Table.AddColumn(\n            Add_FiscalYearNumber,\n            \"FiscalYearLabel\",\n            each \"FY\" & Text.From([FiscalYear]),\n            Text.Type\n        ),\n\n    Add_FiscalYearDefault =\n        Table.AddColumn(\n            Add_FiscalYearLabel,\n            \"FiscalYearDefault\",\n            each\n                if [FiscalYear] = CurrentFiscalYear then \"Current\"\n                else if [FiscalYear] = (CurrentFiscalYear - 1) then \"Previous\"\n                else \"FY\" & Text.From([FiscalYear]),\n            Text.Type\n        ),\n\n    Add_FiscalStartOfYear =\n        Table.AddColumn(\n            Add_FiscalYearDefault,\n            \"FiscalStartOfYear\",\n            each [\n                Offset = if FiscalYearEnd = 12 then 0 else FiscalYearEnd - 12,\n                FiscalStartOfYear = Date.AddMonths(Date.StartOfYear([Date]), Offset)\n            ][FiscalStartOfYear],\n            Date.Type\n        ),\n\n    Add_FiscalEndOfYear =\n        Table.AddColumn(\n            Add_FiscalStartOfYear,\n            \"FiscalEndOfYear\",\n            each Date.AddMonths(Date.EndOfYear([Date]), FiscalYearEnd - 12),\n            Date.Type\n        ),\n\n    Add_FiscalDayOfYear =\n        Table.AddColumn(\n            Add_FiscalEndOfYear,\n            \"FiscalDayOfYear\",\n            each Number.From([Date] - [FiscalStartOfYear]) + 1,\n            Int64.Type\n        ),\n\n    Add_FiscalWeekOfYear =\n        Table.AddColumn(\n            Add_FiscalDayOfYear,\n            \"FiscalWeekOfYear\",\n            each Number.RoundUp([FiscalDayOfYear] / 7),\n            Int64.Type\n        ),\n\n    Add_FiscalWeekLabel =\n        Table.AddColumn(\n            Add_FiscalWeekOfYear,\n            \"FiscalWeekLabel\",\n            each\n                \"FY\" &\n                Text.From([FiscalYear]) &\n                \" W\" &\n                Text.PadStart(Text.From([FiscalWeekOfYear]), 2, \"0\"),\n            Text.Type\n        ),\n\n    Add_FiscalYearOffset =\n        Table.AddColumn(\n            Add_FiscalWeekLabel,\n            \"FiscalYearOffset\",\n            each ([FiscalYear] - CurrentFiscalYear),\n            Int64.Type\n        ),\n\n    Add_FiscalMonthNumber =\n        Table.AddColumn(\n            Add_FiscalYearOffset,\n            \"FiscalMonth\",\n            each Date.Month(Date.AddMonths([Date], -FiscalYearEnd)),\n            Int64.Type\n        ),\n\n    // >>> ADD THIS: Fiscal End Of Month (fiscal month boundary)\n    Add_FiscalEndOfMonth =\n        Table.AddColumn(\n            Add_FiscalMonthNumber,\n            \"FiscalEndOfMonth\",\n            each\n                Date.EndOfMonth(\n                    Date.AddMonths(\n                        Date.StartOfMonth([Date]),\n                        -FiscalYearEnd\n                    )\n                ),\n            Date.Type\n        ),\n\n    Add_FiscalMonthDefault =\n        Table.AddColumn(\n            Add_FiscalEndOfMonth,\n            \"FiscalMonthDefault\",\n            each\n                if Date.IsInCurrentMonth([Date]) then \"Current\"\n                else if Date.IsInPreviousMonth([Date]) then \"Previous\"\n                else Text.From([FiscalMonth]),\n            Text.Type\n        ),\n\n    Add_FiscalQuarterNumber =\n        Table.AddColumn(\n            Add_FiscalMonthDefault,\n            \"FiscalQuarter\",\n            each Number.RoundUp([FiscalMonth] / 3),\n            Int64.Type\n        ),\n\n    Add_FiscalQuarterLabel =\n        Table.AddColumn(\n            Add_FiscalQuarterNumber,\n            \"FiscalQuarterLabel\",\n            each \"FQ\" & Text.From([FiscalQuarter]),\n            Text.Type\n        ),\n\n    Add_FiscalMonthOfQuarter =\n        Table.AddColumn(\n            Add_FiscalQuarterLabel,\n            \"FiscalMonthOfQuarter\",\n            each [FiscalMonth] - 3 * ([FiscalQuarter] - 1),\n            Int64.Type\n        ),\n\n    Add_FiscalYearQuarterLabel =\n        Table.AddColumn(\n            Add_FiscalMonthOfQuarter,\n            \"FiscalYearQuarterLabel\",\n            each \"FY\" & Text.From([FiscalYear]) & \" Q\" & Text.From([FiscalQuarter]),\n            Text.Type\n        ),\n\n    Add_FiscalStartOfQuarter =\n        Table.AddColumn(\n            Add_FiscalYearQuarterLabel,\n            \"FiscalStartOfQuarter\",\n            each Date.StartOfMonth(Date.AddMonths([Date], 1 - [FiscalMonthOfQuarter])),\n            Date.Type\n        ),\n\n    Add_FiscalEndOfQuarter =\n        Table.AddColumn(\n            Add_FiscalStartOfQuarter,\n            \"FiscalEndOfQuarter\",\n            each Date.EndOfMonth(Date.AddMonths([Date], 3 - [FiscalMonthOfQuarter])),\n            Date.Type\n        ),\n\n    Add_FiscalQuarterOffset =\n        Table.AddColumn(\n            Add_FiscalEndOfQuarter,\n            \"FiscalQuarterOffset\",\n            each [\n                CurrentFiscalMonth = Date.Month(Date.AddMonths(Today, -FiscalYearEnd)),\n                CurrentFiscalQuarter = Number.RoundUp(CurrentFiscalMonth / 3),\n                FiscalQuarterOffset =\n                    (([FiscalYear] - CurrentFiscalYear) * 4)\n                        + ([FiscalQuarter] - CurrentFiscalQuarter)\n            ][FiscalQuarterOffset],\n            Int64.Type\n        ),\n\n    Add_FiscalQuarterMonthLabel =\n        Table.AddColumn(\n            Add_FiscalQuarterOffset,\n            \"FiscalQuarterMonthLabel\",\n            each\n                \"FQ\"\n                    & Text.From([FiscalQuarter])\n                    & \": \"\n                    & Date.ToText([FiscalStartOfQuarter], \"MMM yyyy\")\n                    & \" - \"\n                    & Date.ToText([FiscalEndOfQuarter], \"MMM yyyy\"),\n            Text.Type\n        ),\n\n    Add_FiscalDayOfQuarter =\n        Table.AddColumn(\n            Add_FiscalQuarterMonthLabel,\n            \"FiscalDayOfQuarter\",\n            each Number.From([Date] - [FiscalStartOfQuarter]) + 1,\n            Int64.Type\n        ),\n\n    Add_IsCurrentMonth =\n        Table.AddColumn(\n            Add_FiscalDayOfQuarter,\n            \"IsCurrentMonth\",\n            each Date.Year([Date]) = Date.Year(Today)\n                and Date.Month([Date]) = Date.Month(Today),\n            type logical\n        ),\n\n    Add_IsCurrentCalendarYear =\n        Table.AddColumn(\n            Add_IsCurrentMonth,\n            \"IsCurrentCalendarYear\",\n            each Date.Year([Date]) = Date.Year(Today),\n            type logical\n        ),\n\n    Add_IsCurrentFiscalYear =\n        Table.AddColumn(\n            Add_IsCurrentCalendarYear,\n            \"IsCurrentFiscalYear\",\n            each [FiscalYear] = CurrentFiscalYear,\n            type logical\n        ),\n\n    CurrentWeekStart =\n        Date.AddDays(Today, 1 - Date.DayOfWeek(Today, Day.Monday)),\n\n    Add_WeekStart =\n        Table.AddColumn(\n            Add_IsCurrentFiscalYear,\n            \"WeekStart\",\n            each Date.AddDays([Date], 1 - Date.DayOfWeek([Date], Day.Monday)),\n            type date\n        ),\n\n    Add_IsCurrentWeek =\n        Table.AddColumn(\n            Add_WeekStart,\n            \"IsCurrentWeek\",\n            each [WeekStart] = CurrentWeekStart,\n            type logical\n        ),\n\n    Add_IsPreviousMonth =\n        Table.AddColumn(\n            Add_IsCurrentWeek,\n            \"IsPreviousMonth\",\n            each Date.IsInPreviousMonth([Date]),\n            type logical\n        ),\n\n    Add_IsPreviousFiscalYear =\n        Table.AddColumn(\n            Add_IsPreviousMonth,\n            \"IsPreviousFiscalYear\",\n            each [FiscalYear] = (CurrentFiscalYear - 1),\n            type logical\n        ),\n\n    PreviousWeekStart =\n        Date.AddDays(Today, 1 - Date.DayOfWeek(Today, Day.Monday) - 7),\n\n    Add_IsPreviousWeek =\n        Table.AddColumn(\n            Add_IsPreviousFiscalYear,\n            \"IsPreviousWeek\",\n            each [WeekStart] = PreviousWeekStart,\n            type logical\n        ),\n\n    Add_FiscalMonthName =\n        Table.AddColumn(\n            Add_IsPreviousWeek,\n            \"FiscalMonthName\",\n            each \"FM\" & Text.PadStart(Text.From([FiscalMonth]), 2, \"0\"),\n            Text.Type\n        ),\n\n    Add_FiscalMonthNameLong =\n        Table.AddColumn(\n            Add_FiscalMonthName,\n            \"FiscalMonthNameLong\",\n            each \"FM\" & Text.PadStart(Text.From([FiscalMonth]), 2, \"0\") \n                & \" - \" & Date.MonthName([Date]),\n            Text.Type\n        ),\n\n    Add_FiscalWeekName =\n        Table.AddColumn(\n            Add_FiscalMonthNameLong,\n            \"FiscalWeekName\",\n            each \"FW\" & Text.PadStart(Text.From([FiscalWeekOfYear]), 2, \"0\"),\n            Text.Type\n        ),\n\n    #\"Rename Columns\" =\n        Table.TransformColumnNames(\n            Add_FiscalWeekName,\n            each [\n                SplitTextByTransition =\n                    Splitter.SplitTextByCharacterTransition({\"a\" .. \"z\"}, {\"A\" .. \"Z\"})(_),\n                CombineValues = Text.Combine(SplitTextByTransition, \" \"),\n                RemoveUnderscores = Text.Replace(CombineValues, \"_\", \" \")\n            ][RemoveUnderscores]\n        ),\n\n    #\"Inserted Month Name\" =\n        Table.AddColumn(#\"Rename Columns\", \"Month Name\", each Date.MonthName([Date]), type text),\n    #\"Added Custom\" = Table.AddColumn(#\"Inserted Month Name\", \"MMM Label\", each Text.Start([Month Name], 3)),\n    Add_IsCompletedMonth = Table.AddColumn(#\"Added Custom\", \"Is Completed Month\", each Date.EndOfMonth([Date]) < Date.StartOfMonth(Date.From(DateTime.LocalNow())), type logical),\n    #\"Added Custom1\" = Table.AddColumn(Add_IsCompletedMonth, \"Is Completed Quarter\", each [Fiscal End Of Quarter] < Date.From(DateTime.LocalNow()), type logical)\n\nin\n    #\"Added Custom1\""
      }
    }
  }
}